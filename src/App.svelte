<script lang="ts">
	import type { Config as FirebaseConfig } from './interfaces/firebase';

	import TaskList from './components/TaskList.svelte';
	import Battle from './components/Battle.svelte';
	import Inventory from './components/Inventory.svelte';
	import Store from './components/Store.svelte';
	import { initializeApp } from 'firebase/app';
	import { login, logout, AUTH_PROVIDER, getFirebaseAuth } from './utils/auth';
    import { onAuthStateChanged } from 'firebase/auth';
    import MusicButton from './components/MusicButton.svelte';
    import { getUser, getFirstName } from './data/user';
    import { getFirestore } from 'firebase/firestore';
	
	export let firebaseConfig: FirebaseConfig;

	const app = initializeApp(firebaseConfig);
	const auth = getFirebaseAuth(app);
	const db = getFirestore(app);
	
	let battle: boolean;

	$: loggedUser = null;
	$: level = 1;
	$: monster = '';
	$: hero = {
		life: 10,
		power: 1,
		guard: 0,
		speed: 1,
		gold: 1,
		xp: 0,
		level: 1,
		name: getFirstName(loggedUser),
	}

	$: items = [
        {icon: '🍎', name: 'Apple', type: 'consumable', description: 'Recupera a vida.', attrib:{life:5} },
        {icon: '🍌', name: 'Banana', type: 'consumable', description: 'Recupera a vida.', attrib:{life:5} },
        {icon: '🔧', name: 'Wrench', type: 'weapon', description: 'Equipamento.', attrib: {power:1}},
        {icon: '🔨', name: 'Hammer', type: 'weapon', description: 'Equipamento.', attrib: {power:2}},
        {icon: '🏹', name: 'Bow', type: 'weapon', description: 'Equipamento.', attrib: {power:2}},
        {icon: '🔪', name: 'Knife', type: 'weapon', description: 'Equipamento.', attrib: {power:3}},
        {icon: '🗡️', name: 'Sword', type: 'weapon', description: 'Equipamento.', attrib: {power:4}},
        {icon: '🔫', name: 'Revolver', type: 'weapon', description: 'Equipamento.', attrib: {power:5}},
        {icon: '👕', name: 'Shirt', type: 'armor', description: 'Equipamento.', attrib: {guard:1}},
        {icon: '👖', name: 'Jeans', type: 'armor', description: 'Equipamento.', attrib: {guard:1}},
        {icon: '👔', name: 'Formal Shirt', type: 'armor', description: 'Equipamento.', attrib: {guard:1}},
        {icon: '👘', name: 'Kimono', type: 'armor', description: 'Equipamento.', attrib: {guard:1}},
        {icon: '💼', name: 'Mallet', type: 'misc', description: 'Equipamento.', attrib: {guard:1}},
        {icon: '🎒', name: 'Backpack', type: 'misc', description: 'Equipamento.', attrib: {guard:1}},
		{},{},{},{},{},{},{},{},{},{},{}
    ]

	onAuthStateChanged(auth, (user) => {loggedUser = getUser(db, user)});

	function startBattle(event) {
		level = event.detail.level;
		monster = event.detail.monster;
		battle = true;
	}

	function handleBattle(event) {
		hero = event.detail.player;
		battle = false;
	}

	function playerHit() {
		alert(`Don't give up! You lost 1 life!`)
		hero.life-=1;
	}

	function buyItem(event){
		const newItem = event.detail.product
		const addToInventory = addItemToInvetory(newItem)
		if(!addToInventory){
			return alert('Your inventory is Full!')
		}
		hero.gold -= newItem.price
	}

	function addItemToInvetory(newItem){
		let emptySlot = items.find(item => !item.name)
		let emptySlotIndex = items.indexOf(emptySlot)
		if(emptySlotIndex == -1){
			return (false)
		}
		items[emptySlotIndex] = newItem
		return true
	}
</script>

<main>
	{#if battle}
		<Battle
			level={level}
			monster={monster}
			player={hero}
			on:endBattle={handleBattle}
		/>
	{/if}

	<div class="header">
		<div>
			{#if !loggedUser}
				<button 
					on:click={() => {login(auth, AUTH_PROVIDER)}}
				>
					Login
				</button>

			{:else}
				<p 
					class="logout-btn"
					on:click={()=> {logout(auth)}} 
				>
					🚪
				</p>
			{/if}
		</div>
	</div>
	<div class="container">
		<Inventory
			user={loggedUser}
			hero={hero}
			items={items}
		/>
		<TaskList
			player={hero}
			on:startBattle={startBattle}
			on:playerHit={playerHit}
		/>
		<Store gold={hero.gold} on:buyItem={buyItem}/>
		<MusicButton />
	</div>
</main>

<style>
	@import url('https://fonts.googleapis.com/css2?family=Lobster&display=swap');

	main {
		text-align: left;
		padding: 1em;
		max-width: 100vw;
		margin: 0;
		max-height: 100%;

	}

	.container{
		display: flex;
		flex-direction: row;
		align-items: center;
		justify-content: space-between;
		width: 100%;
		max-height: 100%;
	}

	.header{
		display: flex;
		flex-direction: row;
		justify-content: space-between;
		flex: 1;
	}

	.logout-btn {
		cursor: pointer;
		font-size: 30px;
		width: min-content;
		position: absolute;
		top: 0;
		right: 0;
	}

	@media (max-width: 640px) {
		main {
			max-width: none;
		}
		.container{
			flex-direction: column;
			justify-content: flex-start;
		}
	}
</style>